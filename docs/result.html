<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>최종 결과 - 모이새</title>
  <link rel="stylesheet" href="styles.css"/>
  <style>
    .result-wrap { max-width: 800px; margin: 2rem auto; background:#fff; border-radius:12px; padding:1rem 1.2rem; }
    .result-wrap h2 { margin: .2rem 0 1rem; }
    .result-card { background:#fff9ea; border:1px solid #e7d9ad; border-radius:10px; padding:1rem; margin:.8rem 0; }
    .share-row { display:flex; gap:.6rem; margin-top:1rem; }
    .share-row button { padding:.6rem 1rem; border-radius:8px; border:none; background:#a7904d; color:#fff; cursor:pointer; }
    .small { color:#555; font-size:.95rem; margin:.3rem 0 0; }

    /* 좌하단 기부하기 버튼(FAB) */
    .donate-fab {
      position: fixed;
      left: 16px;
      bottom: 16px;
      z-index: 9999;
      padding: .75rem 1rem;
      border: none;
      border-radius: 999px;
      background: #a7904d;
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 6px 18px rgba(0,0,0,.15);
    }
    .donate-fab:active { transform: translateY(1px); }

    /* 모달 */
    .modal-backdrop {
      position: fixed; inset: 0;
      background: rgba(0,0,0,.35);
      display: none;            /* 기본 숨김 */
      align-items: center; justify-content: center;
      z-index: 10000;
    }
    .modal-backdrop.show { display: flex; }
    .modal-box {
      width: min(90vw, 420px);
      background: #fff;
      border-radius: 12px;
      border: 1px solid #e7d9ad;
      padding: 1rem 1.2rem;
      box-shadow: 0 10px 30px rgba(0,0,0,.2);
    }
    .modal-box h3 { margin: 0 0 .6rem; }
    .modal-box p  { margin: 0 0 1rem; line-height: 1.5; }
    .modal-actions { display: flex; gap: .5rem; justify-content: flex-end; }
    .btn {
      padding: .55rem .9rem; border: none; border-radius: 8px; cursor: pointer;
    }
    .btn-primary { background:#a7904d; color:#fff; }
    .btn-ghost  { background:#f2f2f2; color:#333; }
  </style>
</head>
<body>
  <div class="result-wrap" id="resultWrap">
    <h2 id="title">최종 가능한 시간</h2>
    <div id="everyoneBox" class="result-card"></div>
    <div id="bestBox" class="result-card"></div>
  </div>

  <div class="result-wrap">
    <div class="share-row">
      <button id="btnSaveImage">이미지로 저장</button>
      <button id="btnCopyLink">링크 복사</button>
      <button id="btnNewMeeting">새 약속 만들기</button>
    </div>
    <p class="small">* “가능(확실+가능성)” 기준으로 전원 가능 시간대를 먼저 찾고, 없으면 최대 인원 시간대를 보여줍니다.</p>
  </div>

  <!-- 좌측 하단 기부하기 버튼 -->
  <button class="donate-fab" id="donateFab" aria-haspopup="dialog" aria-controls="donateModal">
    기부하기
  </button>

  <!-- 기부 안내 모달 -->
  <div class="modal-backdrop" id="donateModal" role="dialog" aria-modal="true" aria-labelledby="donateTitle">
    <div class="modal-box">
      <h3 id="donateTitle">기부 안내</h3>
      <p>
        기부를 원하신다면<br/>
        <strong>계좌 번호: 12345678</strong> 로 입금해주세요.<br/>
        진심으로 감사합니다!
      </p>
      <div class="modal-actions">
        <button class="btn btn-ghost" id="donateClose">닫기</button>
        <button class="btn btn-primary" id="donateCopy">계좌 복사</button>
      </div>
    </div>
  </div>

  <!-- html2canvas for image export -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <!-- Firebase SDK (third_page와 동일 설정) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCiVW_fvG5hXmt_6aMeDRwXVU19ByRO1iA",
      authDomain: "moysay-d2606.firebaseapp.com",
      databaseURL: "https://moysay-d2606-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "moysay-d2606",
      storageBucket: "moysay-d2606.appspot.com",
      messagingSenderId: "843998694219",
      appId: "1:843998694219:web:219ec5ebdbf835c08076ce"
    };
    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    // 파라미터 room
    const params = new URLSearchParams(location.search);
    const room = params.get('room') || (JSON.parse(localStorage.getItem('meetingInfo'))?.name ?? 'default-room');

    // 제목
    const meetName = JSON.parse(localStorage.getItem('meetingInfo'))?.name || room;
    document.getElementById('title').textContent = `${meetName} - 최종 가능 시간`;

    // DB에서 availability 모두 읽어 집계
    const availRef = ref(db, `rooms/${room}/availabilities`);
    onValue(availRef, (snap) => {
      const rows = snap.val() || {};
      const keys = Object.keys(rows);
      if (keys.length === 0) {
        document.getElementById('everyoneBox').innerHTML = `<p>아직 등록된 시간이 없습니다.</p>`;
        document.getElementById('bestBox').innerHTML = '';
        return;
      }

      // 참가자 집합
      const people = new Set();
      for (const k in rows) people.add(rows[k].name);
      const total = people.size;

      // 30분 그룹화
      const groupMap = new Map(); // key -> {definite, maybe}
      function inc(key, type){
        const cur = groupMap.get(key) || {definite:0, maybe:0};
        cur[type] += 1;
        groupMap.set(key, cur);
      }

      for (const k in rows) {
        const { date, start, end, certainty } = rows[k];
        const [sh, sm] = start.split(':').map(Number);
        const [eh, em] = end.split(':').map(Number);
        const sMin = sh*60+sm, eMin = eh*60+em;

        for (let t = sMin; t < eMin; t += 30) {
          const hh = String(Math.floor(t/60)).padStart(2,'0');
          const mm = String(Math.floor(t%60/30)*30).padStart(2,'0'); // 00 or 30
          const key = `${date} ${hh}:${mm}`;
          inc(key, certainty === 'definite' ? 'definite' : 'maybe');
        }
      }

      const flat = [...groupMap.entries()].map(([key, v]) => ({
        key, totalCan: v.definite + v.maybe, definite: v.definite, maybe: v.maybe
      })).sort((a,b)=>a.key.localeCompare(b.key));

      const everyone = flat.filter(x => x.totalCan === total);
      const best = everyone.length ? [] : (() => {
        const maxCan = flat.reduce((m,x)=>Math.max(m,x.totalCan), 0);
        return flat
          .filter(x => x.totalCan === maxCan)
          .sort((a,b)=> (b.definite - a.definite) || a.key.localeCompare(b.key));
      })();

      // 렌더
      const $every = document.getElementById('everyoneBox');
      const $best  = document.getElementById('bestBox');

      if (everyone.length) {
        $every.innerHTML = `
          <h3>모든 참여자(${total}명) 가능한 시간대</h3>
          <ul>${everyone.map(x=>`<li>${x.key} · (${x.totalCan}/${total})</li>`).join('')}</ul>`;
        $best.innerHTML = '';
      } else {
        $every.innerHTML = `<h3>모든 참여자가 동시에 가능한 시간대는 없습니다</h3>`;
        if (best.length) {
          const maxCan = best[0].totalCan;
          $best.innerHTML = `
            <h3>가장 많은 인원 가능한 시간대 (${maxCan}/${total})</h3>
            <ul>${best.map(x=>`<li>${x.key} · 확실함 ${x.definite}, 가능 ${x.maybe}</li>`).join('')}</ul>`;
        } else {
          $best.innerHTML = `<p>아직 등록된 시간이 없습니다.</p>`;
        }
      }
    });

    // 공유(이미지/링크)
    document.getElementById('btnSaveImage').addEventListener('click', async () => {
      const el = document.getElementById('resultWrap');
      const canvas = await html2canvas(el, { scale: 2 });
      const a = document.createElement('a');
      a.href = canvas.toDataURL('image/png');
      a.download = 'moysay_result.png';
      a.click();
    });
    document.getElementById('btnCopyLink').addEventListener('click', () => {
      const url = `${location.origin}${location.pathname}?room=${encodeURIComponent(room)}`;
      navigator.clipboard.writeText(url).then(()=>alert('링크가 복사되었습니다!'));
    });
    // 새 약속 만들기
    document.getElementById('btnNewMeeting').addEventListener('click', () => {
      localStorage.removeItem('selectedDates');
      localStorage.removeItem('meetingInfo');
      window.location.href = './index.html';
    });

    // ── 기부하기 모달 ─────────────────────────────
    const $fab = document.getElementById('donateFab');
    const $modal = document.getElementById('donateModal');
    const $close = document.getElementById('donateClose');
    const $copy = document.getElementById('donateCopy');
    const ACCOUNT_TEXT = '계좌 번호 12345678';

    const openModal = () => { $modal.classList.add('show'); };
    const closeModal = () => { $modal.classList.remove('show'); };

    $fab.addEventListener('click', openModal);
    $close.addEventListener('click', closeModal);

    // 바깥 클릭 닫기
    $modal.addEventListener('click', (e) => {
      if (e.target === $modal) closeModal();
    });

    // ESC로 닫기
    window.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && $modal.classList.contains('show')) closeModal();
    });

    // 계좌 복사
    $copy.addEventListener('click', async () => {
      try {
        await navigator.clipboard.writeText('12345678');
        alert(`${ACCOUNT_TEXT}가 복사되었습니다!`);
      } catch {
        alert('복사에 실패했습니다. 직접 입력해주세요: 12345678');
      }
    });
  </script>
</body>
</html>
